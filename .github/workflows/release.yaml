name: Release Automation

on:
  push:
    branches:
      - main  # Trigger release on push to main branch

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v3

      # Set up Git for tagging
      - name: Set up Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      # Determine the version based on commit messages
      - name: Get current version
        id: version
        run: |
          # Get the latest tag (if any)
          latest_tag=$(git describe --tags --abbrev=0)
          echo "Latest tag: $latest_tag"

          # If no tags exist, start with 0.1.0
          if [ -z "$latest_tag" ]; then
            version="v0.1.0"
          else
            # Increment the version based on the latest tag
            IFS='.' read -r -a version_parts <<< "${latest_tag//v/}"
            major=${version_parts[0]}
            minor=${version_parts[1]}
            patch=${version_parts[2]}

            # Determine commit type and increment version
            if git log -1 --pretty=%B | grep -q '^feat:'; then
              minor=$((minor + 1))
              patch=0
            elif git log -1 --pretty=%B | grep -q '^fix:'; then
              patch=$((patch + 1))
            else
              # If no significant changes, just increment the patch
              patch=$((patch + 1))
            fi

            # Construct the new version
            version="v$major.$minor.$patch"
          fi

          echo "New version: $version"
          echo "VERSION=$version" >> $GITHUB_ENV

      # Create the new Git tag
      - name: Create tag for release
        run: |
          git tag ${{ env.VERSION }}
          git push origin ${{ env.VERSION }}

      # Create a GitHub release
      - name: Create GitHub release
        id: release
        uses: gh action-create-release@v1
        with:
          tag_name: ${{ env.VERSION }}
          release_name: "Release ${{ env.VERSION }}"
          body: "Automated release based on tag ${{ env.VERSION }}"
          draft: false
          prerelease: false

      # Upload the compiled `.exe` to the release
      - name: Upload release asset
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.release.outputs.upload_url }}
          asset_path: ./path/to/your/compiled/exe
          asset_name: ping.exe
          asset_content_type: application/octet-stream
